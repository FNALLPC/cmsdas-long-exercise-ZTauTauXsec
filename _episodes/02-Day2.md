---
title: "Exercise 2"
# teaching: 0
# exercises: 0
# questions:
# - "Key question (FIXME)"
# objectives:
# - "First learning objective. (FIXME)"
# keypoints:
# - "First key point. Brief Answer to questions. (FIXME)"
---
# Event Analysis code

We now need to write the main portion of the code which will reconstruct our Z candidate, as well as other variables which we will use in the background estimation. At the very least, you will need to include

- The visible mass of your reconstructed final state particle pair.
    - If the event does not have such a pair, you may discard it (return False) as you will never be using it for your analysis.
- The number of b-tagged jets.
    - b-tagging is achieved with the Jet_btagDeepB variable, where you require the value to be greater than 0.1241, 0.4184, 0.7527 depending on your intended working point.
        - <https://twiki.cern.ch/twiki/bin/view/CMS/BtagRecommendation#Recommendation_for_13_TeV_Data>
- The transverse mass of either $e+$MET or $\mu+$MET (for $e+\tau_h$ or $\mu+\tau_h$ only).


Start with [`exampleModule.py`](https://github.com/fojensen/nanoAOD-tools/blob/cmsdas2022/python/postprocessing/examples/exampleModule.py) as a boiler plate and create a new analyze function to calculate the relevant variables for your analysis on an event-by-event basis.

It is similiar to the `exampleAnalysis.py` you modified yesterday, but instead of creating a histogram this creates a new branch EventMass which is added to the Events tree in addition to those already in the NANOAOD file. To run the example:

```shell
cd ${CMSSW_BASE}/src/PhysicsTools/NanoAODTools/analysis/
python ${CMSSW_BASE}/src/PhysicsTools/NanoAODTools/python/postprocessing/examples/example_postproc.py
```


The input file is an old TTJets MC sample, which you will need to switch to the DYJetsToLL_M-50 signal file used yesterday. As we are now working to understand the backgrounds in addition to our Z signal, you may interested in any of the following three MC samples, accessed in the following manner:
```
root://cmseos.fnal.gov//store/user/cmsdas/2022/short_exercises/Tau/DYJetsToLL__7B7D90CB-14EF-B749-B4D7-7C413FE3CCC1.root
root://cmseos.fnal.gov//store/user/cmsdas/2022/short_exercises/Tau/WJetsToLNu__AE18A33F-9CF5-BC4E-A1E9-46F7BF382AF1.root
root://cmseos.fnal.gov//store/user/cmsdas/2022/short_exercises/Tau/TTTo2L2Nu__1656732C-0CD4-F54B-B39D-19CA08E18A77.root
```


> ## Deliverable 
> Deliverable by the early end of the day: For each of the MC samples, make a histogram of the three variables mentioned in the bullets above. An example code to make the histograms from a given file/TTree and plot them can be found [here](https://twiki.cern.ch/twiki/pub/CMS/SWGuideCMSDataAnalysisSchoolLPC2023ZTauTauXsec/exPlot.c). Before we submit jobs to [condor](https://uscms.org/uscms_at_work/computing/setup/batch_systems.shtml#condor_2) to run over the whole datasets (which takes overnight) please understand these distributions:
>
> - Are you able to see a peak in the visible mass distribution in the Z mc? (You can compare with Slide 10 of the introductory slides.)
> - How many b-tagged jets do you expect in in the TTJets MC sample? DYJetsToLL_M-50, WJetsToLNu?
> - Does your mt distribution in the WJetsToLNu MC appear as you would expect; given the W boson mass is 80.379. (You can compare with that seen on Slide 8 of the introductory slides.)
{: .challenge}

As you make these, please paste these in the Mattermost chat for discussion and comparisons.

Once you have made (and tested/verified) your main analysis loops it is now time to run the code on the full datasets including MC. We will use condor to process the data. This is done with a script called [`submitToGrid.py`](https://github.com/fojensen/nanoAOD-tools/blob/cmsdas2022/condor/submitToGrid.py). You will need to modify your username on [L1](https://github.com/fojensen/nanoAOD-tools/blob/cmsdas2022/condor/submitToGrid.py#L1). You can see the "main" function which is called is [`example_postproc.py`](https://github.com/fojensen/nanoAOD-tools/blob/cmsdas2022/python/postprocessing/examples/example_postproc.py) which we modified before.

You may see the list of our datasets and mc samples of interest which will be submitted [here](https://github.com/fojensen/nanoAOD-tools/blob/cmsdas2022/condor/submitToGrid.py#L35-L40). One job is created for each of those files. These are skims which have made of the entire datasets prior to CMSDAS. To (drastically) increase processing time and decrease the output file size, make sure to enable [friend mode](https://github.com/cms-nanoAOD/nanoAOD-tools/blob/master/python/postprocessing/framework/postprocessor.py#L33). This creates a friend tree. This ensures that only new variables which you created are written into your output tree, and not the entire Events tree.. Do not apply any additional [preselection](https://github.com/cms-nanoAOD/nanoAOD-tools/blob/master/python/postprocessing/framework/postprocessor.py#L27) at this time either. [Friends](https://root.cern/manual/trees/#widening-a-ttree-through-friends) are important. The smaller input files may finish within 30 minutes, check one of these to make sure everything is as expected (ZZ has 0 entries so do not be worried about this file).

```shell
cd ${CMSSW_BASE}/src/PhysicsTools/NanoAODTools/condor/
python submitToGrid.py
```

